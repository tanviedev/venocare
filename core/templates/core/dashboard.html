{% extends 'core/base.html' %}
{% load static %}

{% block content %}
<link rel="stylesheet" href="{% static 'core/style.css' %}">

<!-- Home button below navbar -->
<div class="home-button-wrapper">
  <a href="{% url 'home' %}" class="home-btn">ğŸ  Home</a>
</div>

<div class="dashboard-container">
  <h2 class="greeting">Hello, {{ user.username }}</h2>

  <div class="dashboard-actions">
    <a href="{% url 'upload_image' %}" class="action-btn primary">ğŸ“¤ Upload Image</a>
    <a href="{% url 'my_recovery_plan' %}" class="action-btn success">ğŸ“‹ Recovery Plan</a>
    <a href="{% url 'daily_checkin' %}" class="action-btn warning">ğŸ—“ï¸ Daily Check-in</a>
    <a href="{% url 'export_user_reports_csv' %}" class="action-btn secondary">ğŸ“ Export Reports (CSV)</a>
  </div>

  <div class="tts-section">
    <label for="tts-lang">ğŸ”Š Select Language:</label>
    <select id="tts-lang">
      <option value="en">English</option>
      <option value="hi">Hindi</option>
      <option value="mr">Marathi</option>
    </select>
    <button id="dashboard-tts-toggle" onclick="toggleDashboardTTS()">â–¶ï¸ Read Dashboard Summary</button>
  </div>

  <h3 class="section-title">ğŸ“ˆ Scan Trends</h3>
  <canvas id="scanChart" width="400" height="200"></canvas>

  {{ dates|json_script:"dates-data" }}
  {{ scores|json_script:"scores-data" }}
  {{ stages|json_script:"stages-data" }}

  <h3 class="section-title">ğŸ–¼ï¸ Your Past Scans</h3>
  <ul class="scan-history">
    {% for p in images %}
      <li>{{ p.uploaded_at }} â€” Score: {{ p.rvcss_score }} | Stage: {{ p.stage }}</li>
    {% empty %}
      <li>No scans saved yet.</li>
    {% endfor %}
  </ul>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  const dashboardTranslations = {
    en: {
      welcome: "Welcome to your VenoCare Dashboard.",
      activity: "You have uploaded {{ uploaded_count }} scans.",
      progress: "Your last rVCSS score was {{ latest_score }}.",
      tip: "Remember to check-in daily for faster recovery."
    },
    hi: {
      welcome: "à¤†à¤ªà¤•à¥‡ à¤µà¥‡à¤¨à¥‹à¤•à¥‡à¤¯à¤° à¤¡à¥ˆà¤¶à¤¬à¥‹à¤°à¥à¤¡ à¤®à¥‡à¤‚ à¤¸à¥à¤µà¤¾à¤—à¤¤ à¤¹à¥ˆà¥¤",
      activity: "à¤†à¤ªà¤¨à¥‡ {{ uploaded_count }} à¤¸à¥à¤•à¥ˆà¤¨ à¤…à¤ªà¤²à¥‹à¤¡ à¤•à¤¿à¤ à¤¹à¥ˆà¤‚à¥¤",
      progress: "à¤†à¤ªà¤•à¤¾ à¤…à¤‚à¤¤à¤¿à¤® à¤†à¤°à¤µà¥€à¤¸à¥€à¤à¤¸à¤à¤¸ à¤¸à¥à¤•à¥‹à¤° à¤¥à¤¾ {{ latest_score }}à¥¤",
      tip: "à¤¤à¥‡à¤œà¤¼ à¤¸à¥à¤§à¤¾à¤° à¤•à¥‡ à¤²à¤¿à¤ à¤°à¥‹à¤œà¤¼à¤¾à¤¨à¤¾ à¤šà¥‡à¤•-à¤‡à¤¨ à¤•à¤°à¤¨à¤¾ à¤¨ à¤­à¥‚à¤²à¥‡à¤‚à¥¤"
    },
    mr: {
      welcome: "à¤¤à¥à¤®à¤šà¥à¤¯à¤¾ à¤µà¥‡à¤¨à¥‹à¤•à¥‡à¤…à¤° à¤¡à¥…à¤¶à¤¬à¥‹à¤°à¥à¤¡à¤®à¤§à¥à¤¯à¥‡ à¤¸à¥à¤µà¤¾à¤—à¤¤ à¤†à¤¹à¥‡.",
      activity: "à¤¤à¥à¤®à¥à¤¹à¥€ {{ uploaded_count }} à¤¸à¥à¤•à¥…à¤¨ à¤…à¤ªà¤²à¥‹à¤¡ à¤•à¥‡à¤²à¥‡ à¤†à¤¹à¥‡à¤¤.",
      progress: "à¤¤à¥à¤®à¤šà¤¾ à¤¶à¥‡à¤µà¤Ÿà¤šà¤¾ à¤†à¤°à¤µà¥à¤¹à¥€à¤¸à¥€à¤à¤¸à¤à¤¸ à¤¸à¥à¤•à¥‹à¤…à¤° à¤¹à¥‹à¤¤à¤¾ {{ latest_score }}.",
      tip: "à¤œà¤²à¤¦ à¤¸à¥à¤§à¤¾à¤°à¤¾à¤¸à¤¾à¤ à¥€ à¤¦à¤°à¤°à¥‹à¤œ à¤šà¥‡à¤•-à¤‡à¤¨ à¤•à¤°à¤¾à¤¯à¤²à¤¾ à¤µà¤¿à¤¸à¤°à¥‚ à¤¨à¤•à¤¾."
    }
  };

  let synth = window.speechSynthesis;
  let utterance;
  let isSpeaking = false;
  let isPaused = false;

  function toggleDashboardTTS() {
    const button = document.getElementById("dashboard-tts-toggle");
    const lang = document.getElementById("tts-lang").value;

    if (lang === 'mr') {
      alert("Marathi voice not supported on most browsers. Using Hindi voice.");
    }

    if (isSpeaking && !isPaused) {
      synth.pause();
      isPaused = true;
      button.innerText = "â¸ï¸ Paused (Click to Resume)";
      return;
    }

    if (isPaused) {
      synth.resume();
      isPaused = false;
      button.innerText = "â¹ï¸ Speaking... (Click to Pause)";
      return;
    }

    const t = dashboardTranslations[lang];
    const message = `${t.welcome} ${t.activity} ${t.progress} ${t.tip}`;

    utterance = new SpeechSynthesisUtterance(message);
    utterance.lang = (lang === 'mr') ? 'hi-IN' : lang + '-IN';

    utterance.onstart = () => {
      isSpeaking = true;
      button.innerText = "â¹ï¸ Speaking... (Click to Pause)";
    };

    utterance.onend = () => {
      isSpeaking = false;
      isPaused = false;
      button.innerText = "â–¶ï¸ Read Dashboard Summary";
    };

    synth.cancel();
    synth.speak(utterance);
  }

  const dates = JSON.parse(document.getElementById('dates-data').textContent);
  const scores = JSON.parse(document.getElementById('scores-data').textContent);
  const stages = JSON.parse(document.getElementById('stages-data').textContent);

  new Chart(document.getElementById("scanChart"), {
    type: 'line',
    data: {
      labels: dates,
      datasets: [{
        label: "rVCSS Score",
        data: scores,
        borderColor: "#104944",
        backgroundColor: "rgba(16, 73, 68, 0.1)",  // âœ… transparent green fill
        fill: true,                                // âœ… fill area below the line
        tension: 0.1,                               // optional: smooth curves
        pointBackgroundColor: "#104944",
      }]
    }
  });
</script>
{% endblock %}
